var bgmodule=chrome.extension.getBackgroundPage();var type_default=["main_frame","sub_frame","stylesheet","script","image","object","xmlhttprequest","other"];var type_default_text=["Main frame","Sub frame","Stylesheet","Script","Image","Object","xmlhttprequest","Other"];var viewlog_refreshhotkey,viewlog_refreshhotkey2;var viewlog_clearhotkey,viewlog_clearhotkey2;function get_actionkey(a,b){var c="";if(a=="ctrl+shift"){c="Ctrl+Shift+"}else{if(a=="ctrl+alt"){c="Ctrl+Alt+"}else{if(a=="ctrl"){c="Ctrl+"}else{if(a=="alt"){c="Alt+"}else{if(a=="shift"){c="Shift+"}}}}}if((b>=65)&&(b<=90)){c=c+String.fromCharCode(b)}else{if((b>=112)&&(b<=121)){c=c+"F"+(b-111)}else{if((b>=48)&&(b<=57)){c=c+String.fromCharCode(b)}else{if((b>=188)&&(b<=191)){c=c+String.fromCharCode(b-188+44)}else{if((b>=219)&&(b<=221)){c=c+String.fromCharCode(b-219+91)}else{if(b==37){c=c+"Left"}else{if(b==38){c=c+"Up"}else{if(b==39){c=c+"Right"}else{if(b==40){c=c+"Down"}else{if(b==33){c=c+"PageUp"}else{if(b==34){c=c+"PageDown"}else{if(b==35){c=c+"End"}else{if(b==36){c=c+"Home"}else{c=""}}}}}}}}}}}}}if(c==""){c=chrome.i18n.getMessage("conf_none")}return c}function init(){try{viewlog_refreshhotkey=toSafeString(localStorage.viewlog_refreshhotkey);viewlog_refreshhotkey=viewlog_refreshhotkey.toLowerCase();viewlog_refreshhotkey2=toSafeString(localStorage.viewlog_refreshhotkey2);var d=document.getElementById("btn_reload");if(d){d.innerHTML="<img src='images/reload.png' align='absmiddle'> "+_i18n("msg_refresh")+"("+get_actionkey(viewlog_refreshhotkey,viewlog_refreshhotkey2)+")"}viewlog_clearhotkey=toSafeString(localStorage.viewlog_clearhotkey);viewlog_clearhotkey=viewlog_clearhotkey.toLowerCase();viewlog_clearhotkey2=toSafeString(localStorage.viewlog_clearhotkey2);var d=document.getElementById("btn_clear");if(d){d.innerHTML="<img src='images/clear.png' align='absmiddle'> "+_i18n("msg_clearlog")+"("+get_actionkey(viewlog_clearhotkey,viewlog_clearhotkey2)+")"}}catch(h){}var d=document.getElementById("log_enable");d.checked=bgmodule.g_config.log_enable;d.disabled=!bgmodule.g_config.change_enable;var d=document.getElementById("config_pattern");d.onkeydown=config_pattern_onkeydown;document.addEventListener("mousedown",doc_mousedown);document.addEventListener("keydown",doc_keydown);for(var g=0;g<type_default.length;++g){var d=document.getElementById("config_type_"+type_default[g]);if(d){d.checked=false;d.onchange=function(){proc_setconfig()}}}var e={};try{e=JSON.parse(localStorage.log_config)}catch(h){}try{if(e.type){for(var g=0;g<e.type.length;++g){for(var f=0;f<type_default.length;++f){if(e.type[g]==type_default[f]){var c=document.getElementById("config_type_"+type_default[f]);if(c){c.checked=true}}}}}var c=document.getElementById("config_method");c.value=e.method;var c=document.getElementById("config_pattern");if(!e.pattern){e.pattern=""}c.value=e.pattern;var c=document.getElementById("config_enablepattern");if(e.enablepattern==null){e.enablepattern=true}c.checked=e.enablepattern;var c=document.getElementById("config_autoselect");if(e.autoselect==null){e.autoselect=false}c.checked=e.autoselect}catch(h){}proc_uichange();proc_loadlog();setTimeout(function(){if(!bgmodule.g_config.log_enable){show_message("<label2><font style='font-size:13px'>URL sniffer feature is disabled. You have to enable URL sniffer feature on menus.</font></label2>",null,null,null,3500)}},150)}function proc_setconfig(f){var e=[];for(var d=0;d<type_default.length;++d){var b=document.getElementById("config_type_"+type_default[d]);if(b&&b.checked){e[e.length]=type_default[d]}}var b={};b.type=e;b.method=document.getElementById("config_method").value;b.pattern=document.getElementById("config_pattern").value;b.enablepattern=document.getElementById("config_enablepattern").checked;b.autoselect=document.getElementById("config_autoselect").checked;localStorage.log_config=JSON.stringify(b);if(!f){close_viewheader();proc_loadlog()}}function proc_loadlog(){var q=document.getElementById("log_data");var p=bgmodule.g_config.log_data;var m={};try{m=JSON.parse(localStorage.log_config)}catch(h){}m.re=null;if(m.enablepattern&&m.pattern){var r=m.pattern;if(r.indexOf("r/")==0){r=r.substr(2,r.length)}else{r=r.replace(/\./g,"\\.").replace(/\?/g,"\\?").replace(/\x2a/g,"(.*)");r="^"+r+"$"}try{m.re=new RegExp(r)}catch(h){}}var d,g,n;var r='<table width=1300 border="1" cellpadding="1" cellspacing="0" bordercolor="silver" style="border-collapse:collapse"><td align=center width=30><b>'+_i18n("msg_time")+"</b><td align=center><b>Type(Filter)</b><td align=center><b>Method</b><td width=700 align=center><b>URL</b><td width=30><td align=center width=30><b>"+_i18n("msg_header")+"</b><td width=400 align=center><b>"+_i18n("msg_changedua")+"</b>";for(var l=0;l<p.length;++l){var o=p[l];if(m.re){if(!o.details.url.match(m.re)){continue}}var f=m.type;if(f&&f.length>0){n=false;for(var k=0;k<f.length;++k){if(f[k]==o.details.type){n=true;break}}if(!n){continue}}var f=m.method;if(f){if(o.details.method!=f){continue}}var e=new Date(o.details.timeStamp);g=e.getHours()+":"+e.getMinutes()+":"+e.getSeconds();d=html_entity_encode(o.details.url);r=r+"<tr>";r=r+"<td>"+g+"<td>"+o.details.type+"<td>"+o.details.method+'<td><input type=text style="width:100%" id="fix1_3_'+l+'" value="'+d+'"><td><a href="'+d+'" target="_blank">'+_i18n("msg_link")+'</a><td align=center><a id="fix1_5_'+l+'" href="#" class=alinktext>'+_i18n("msg_view")+'</a><td><input type=text style="width:100%" value="'+html_entity_encode(o.data[0].value)+'" id="fix1_4_'+l+'">'}r=r+"</table>";q.innerHTML=r;for(var l=0;l<p.length;++l){var q=_getid("fix1_3_"+l);if(q){q.onclick=function(){input_onclick(this)}}var q=_getid("fix1_4_"+l);if(q){q.onclick=function(){input_onclick(this)}}var q=_getid("fix1_5_"+l);if(q){q.data=l;q.onclick=function(){proc_viewheader(event,this.data);return false}}}}function input_onclick(c){var b=document.getElementById("config_autoselect");if(b.checked){if(window.getSelection()){window.getSelection().setBaseAndExtent(c,0,c,1)}}}function proc_viewheader(e,v){var p=bgmodule.g_config.log_data;if((v<0)||(v>p.length-1)){return}var n=p[v];var t=n.details.requestHeaders;if(!t){return}var w="";for(var j=0;j<t.length;++j){if(w){w=w+"\n"}w=w+t[j].name+": "+t[j].value}var p=e.target;var d=0;var g=0;while(p&&!isNaN(p.offsetLeft)&&!isNaN(p.offsetTop)){d+=p.offsetLeft;g+=p.offsetTop;p=p.offsetParent}var r=d+e.target.offsetWidth+7;var o=g+1;var t=document.getElementById("layer_headers");var p=document.getElementById("txt_viewheader");if(p){p.value=w}else{w="&nbsp;<label>["+_i18n("msg_orgheader")+']</label>&nbsp;<a id="fix1_6" href="#" class=alinktext title="'+_i18n("msg_close")+'"><img src="images/close.png" align="absmiddle"></a>&nbsp;&nbsp;<label><input id="viewlog_viewheaderautoclose" type=checkbox>'+_i18n("msg_autocloseonclick")+'</label><br><textarea id="txt_viewheader" style="width:550px;height:140px;background-color:#FFFFE1;border:0px;padding:3px" wrap="on">'+w+"</textarea>";t.innerHTML=w}t.style["background-color"]="#FFFFE1";t.style.border="1px solid #000000";t.style.padding="0px";t.style.display="";var n=_getid("fix1_6");if(n){n.onclick=function(){close_viewheader();return false}}var n=document.getElementById("viewlog_viewheaderautoclose");if(n){n.onclick=viewlog_viewheaderautoclose_onclick;n.checked=toBool(localStorage.viewlog_viewheaderautoclose)}var f=r;var q=o;var l=t.offsetWidth;var m=t.offsetHeight;var u=30;if((r+l)>(window.innerWidth-u)){r=(window.innerWidth-u)-l}var k=document.body.scrollTop+window.innerHeight;if((o+m)>(k-u)){o=(k-u)-m}if(r<f){r=d-l-3}if(r<0){r=0}t.style.left=r+"px";t.style.top=o+"px"}function close_viewheader(){var b=document.getElementById("layer_headers");if(b){b.style.display="none"}}function viewlog_viewheaderautoclose_onclick(){var a=document.getElementById("viewlog_viewheaderautoclose");if(a){localStorage.viewlog_viewheaderautoclose=a.checked}}function doc_mousedown(d){if(d.button!=0){return}var c=document.getElementById("layer_headers");if(c&&(c.style.display=="")){if(!toBool(localStorage.viewlog_viewheaderautoclose)){return}var a=d.target;while(a){if(a.id=="layer_headers"){return}a=a.parentElement}c.style.display="none"}}function doc_keydown(h){var f=h.keyCode;var d=typeof h.modifiers=="undefined"?h.ctrlKey:h.modifiers&Event.CONTROL_MASK;var c=typeof h.modifiers=="undefined"?h.altKey:h.modifiers&Event.ALT_MASK;var b=typeof h.modifiers=="undefined"?h.shiftKey:h.modifiers&Event.SHIFT_MASK;var g="";if((d)&&(b)){g="ctrl+shift"}else{if((d)&&(c)){g="ctrl+alt"}else{if(d){g="ctrl"}else{if(c){g="alt"}else{if(b){g="shift"}}}}}var a=false;if((f==viewlog_refreshhotkey2)&&(g==viewlog_refreshhotkey)){proc_loadlog();a=true}else{if((f==viewlog_clearhotkey2)&&(g==viewlog_clearhotkey)){proc_clearlog();a=true}}if(a){h.preventDefault();h.stopPropagation();h.returnValue=false}}function proc_clearlog(){bgmodule.g_config.log_data=[];proc_loadlog();close_viewheader()}function config_pattern_onkeydown(f){var d=f.keyCode;var c=typeof f.modifiers=="undefined"?f.ctrlKey:f.modifiers&Event.CONTROL_MASK;var b=typeof f.modifiers=="undefined"?f.altKey:f.modifiers&Event.ALT_MASK;var a=typeof f.modifiers=="undefined"?f.shiftKey:f.modifiers&Event.SHIFT_MASK;if((!c)&&(!b)&&(!a)){if(d==13){proc_setconfig();return}}}function config_pattern_help(){var a='ex: http*://www.google.*/*, http://*.google.com*\n\nYou can use regular expression. paste "r/" before regular expression.\nex: r/^http:\\/\\/[A-Za-z0-9]+\\/';alert(a)}function proc_uichange(){var e=document.getElementById("config_enablepattern");var d=document.getElementById("config_pattern");var h=document.getElementById("btn_apply");var g;if(e.checked){g=false}else{g=true}d.disabled=g;h.disabled=g}function log_enable_onchange(){var b=document.getElementById("log_enable");localStorage.log_enable=b.checked;bgmodule.g_config.log_enable=b.checked}function proc_onload(){proc_setlang();_getid("btn_reload").onclick=proc_loadlog;_getid("btn_clear").onclick=proc_clearlog;_getid("log_enable").onclick=log_enable_onchange;_getid("config_method").onchange=function(){proc_setconfig()};_getid("config_enablepattern").onclick=function(){proc_setconfig();proc_uichange()};_getid("btn_apply").onclick=function(){proc_setconfig()};_getid("config_autoselect").onclick=function(){proc_setconfig(true)};_getid("fix1_1").onclick=function(){config_pattern_help();return false};_getid("fix1_2").onclick=function(){open_newtab_extension("options.html");return false};init()}window.onload=proc_onload;function windowonresize(){var a=document.getElementById("layer_message");if(a){a.style.display="none"}var a=document.getElementById("layer_message2");if(a){a.style.display="none"}var a=document.getElementById("layer_message3");if(a){a.style.display="none"}}window.onresize=windowonresize;chrome.extension.onRequest.addListener(function(e,d,b){if(e.action=="config_changed"){var c=document.getElementById("log_enable");if(c){c.checked=bgmodule.g_config.log_enable;c.disabled=!bgmodule.g_config.change_enable}}});